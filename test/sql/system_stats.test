# name: test/sql/system_stats.test
# description: test system_stats extension
# group: [sql]

# Require statement will ensure this test is run with this extension loaded
require system_stats

# Test sys_memory_info function
query IIIIIII
SELECT 
    total_memory > 0,
    used_memory > 0,
    free_memory >= 0,
    cached_memory >= 0,
    total_swap >= 0,
    used_swap >= 0,
    free_swap >= 0
FROM sys_memory_info();
----
true	true	true	true	true	true	true

# Test that total memory is greater than used memory
query I
SELECT total_memory > used_memory FROM sys_memory_info();
----
true

# Test that total swap equals used + free swap (if swap exists)
query I
SELECT CASE 
    WHEN total_swap > 0 THEN total_swap >= (used_swap + free_swap) * 0.99
    ELSE true
END
FROM sys_memory_info();
----
true

# Test that the function returns exactly one row
query I
SELECT COUNT(*) FROM sys_memory_info();
----
1

# Test that all memory values are numeric and not null
query I
SELECT COUNT(*) FROM sys_memory_info()
WHERE total_memory IS NOT NULL
  AND used_memory IS NOT NULL
  AND free_memory IS NOT NULL
  AND cached_memory IS NOT NULL
  AND total_swap IS NOT NULL
  AND used_swap IS NOT NULL
  AND free_swap IS NOT NULL;
----
1

# Test sys_cpu_info function
query I
SELECT COUNT(*) FROM sys_cpu_info();
----
1

# Test that CPU info returns valid data
query I
SELECT 
    CASE 
        WHEN model_name IS NOT NULL 
          OR architecture IS NOT NULL
          OR no_of_cores > 0 
        THEN 1 
        ELSE 0 
    END
FROM sys_cpu_info();
----
1

# Test that core counts are valid
query I
SELECT 
    CASE 
        WHEN logical_processor >= no_of_cores 
          AND physical_processor >= 0
          AND no_of_cores > 0
        THEN 1 
        ELSE 0 
    END
FROM sys_cpu_info();
----
1

# Test that all CPU columns exist and are not causing errors
query I
SELECT COUNT(*) FROM sys_cpu_info()
WHERE model_name IS NOT NULL
  AND cpu_vendor IS NOT NULL
  AND architecture IS NOT NULL
  AND logical_processor IS NOT NULL
  AND physical_processor IS NOT NULL
  AND no_of_cores IS NOT NULL
  AND cpu_clock_speed IS NOT NULL
  AND l1dcache_size IS NOT NULL
  AND l1icache_size IS NOT NULL
  AND l2cache_size IS NOT NULL
  AND l3cache_size IS NOT NULL
  AND cpu_family IS NOT NULL
  AND cpu_type IS NOT NULL
  AND cpu_byte_order IS NOT NULL;
----
1
